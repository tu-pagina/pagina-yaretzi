<script>
/* ---------- Constantes y storage keys ---------- */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEIff6bI_-fpViBpkAo5ptOz-kYl2NNPNeLWCGQ6EAgGVJcIiFUJSR79EJsRAz-Urs/exec';
let entriesCache = [];
let albumCache = [];

/* ---------- Temporizador ---------- */
// (igual que antes)
const targetDate = new Date(2025, 9, 18, 0, 0, 0);
let timerInterval = null;
let confettiShown = false;
function startTimer(){/* tu código de temporizador sin cambios */}

/* ---------- Funciones para Apps Script ---------- */
async function fetchData(){
  try{
    const res = await fetch(SCRIPT_URL + '?action=get');
    const data = await res.json();
    entriesCache = data.entries || [];
    albumCache = data.album || [];
  } catch(e){
    console.error('Error al cargar datos:', e);
  }
}

async function saveEntry(entry){
  entriesCache.push(entry);
  await fetch(SCRIPT_URL + '?action=saveEntry', {
    method: 'POST',
    body: JSON.stringify(entry)
  });
}

async function deleteEntry(id){
  entriesCache = entriesCache.filter(e => e.id !== id);
  await fetch(SCRIPT_URL + '?action=deleteEntry', {
    method: 'POST',
    body: JSON.stringify({id})
  });
}

async function saveAlbumItem(item){
  albumCache.push(item);
  await fetch(SCRIPT_URL + '?action=saveAlbum', {
    method: 'POST',
    body: JSON.stringify(item)
  });
}

async function deleteAlbumItem(id){
  albumCache = albumCache.filter(e => e.id !== id);
  await fetch(SCRIPT_URL + '?action=deleteAlbum', {
    method: 'POST',
    body: JSON.stringify({id})
  });
}

/* ---------- Renderizado ---------- */
function renderEntries(){
  const container = document.getElementById('entries');
  container.innerHTML = '';
  if (!entriesCache.length) {
    container.innerHTML = '<p class="muted-txt">Aún no hay entradas — añade una desde el formulario.</p>';
    return;
  }
  entriesCache.slice().reverse().forEach(entry => {
    const div = document.createElement('div');
    div.className = 'entry';
    const date = new Date(entry.fecha);
    const dateStr = date.toLocaleString('es-CO', { dateStyle:'medium', timeStyle:'short' });
    div.innerHTML = `
      <div class="meta">
        <div><strong>${escapeHtml(entry.titulo)}</strong><div class="muted-txt">${dateStr}</div></div>
        <div>
          <button class="btn small" data-id="${entry.id}" data-action="del">Eliminar</button>
        </div>
      </div>
      <div style="margin-top:8px">${escapeHtml(entry.texto)}</div>
    `;
    if (entry.foto){
      const img = document.createElement('img');
      img.src = entry.foto;
      img.alt = entry.titulo || 'foto';
      img.style.cursor = 'zoom-in';
      img.addEventListener('click', ()=> openLightbox(entry.foto));
      div.appendChild(img);
    }
    container.appendChild(div);
  });
}

function renderAlbum(){
  const grid = document.getElementById('albumGrid');
  grid.innerHTML = '';
  if (!albumCache.length){
    grid.innerHTML = '<div class="muted-txt">No hay fotos en el álbum. Sube algunas usando "Seleccionar archivos".</div>';
    return;
  }
  albumCache.slice().reverse().forEach(item => {
    const node = document.createElement('div');
    node.className = 'album-item';
    node.innerHTML = `<button class="del" title="Eliminar foto" data-id="${item.id}">✕</button>`;
    const img = document.createElement('img');
    img.src = item.src;
    img.alt = 'foto álbum';
    img.addEventListener('click', ()=> openLightbox(item.src));
    node.appendChild(img);
    grid.appendChild(node);
  });
}

/* ---------- Eventos ---------- */
document.getElementById('diarioForm').addEventListener('submit', async function(ev){
  ev.preventDefault();
  const titulo = document.getElementById('titulo').value.trim();
  const texto = document.getElementById('texto').value.trim();
  const fileInput = document.getElementById('foto');
  const file = fileInput.files && fileInput.files[0];
  const entry = { id: Date.now(), titulo, texto, fecha: new Date().toISOString(), foto: null };
  
  if (file){
    const reader = new FileReader();
    reader.onload = async function(evt){
      entry.foto = evt.target.result;
      await saveEntry(entry);
      renderEntries();
      document.getElementById('diarioForm').reset();
    };
    reader.readAsDataURL(file);
  } else {
    await saveEntry(entry);
    renderEntries();
    document.getElementById('diarioForm').reset();
  }
});

document.addEventListener('click', async function(e){
  const btnEntry = e.target.closest('button[data-action="del"]');
  if (btnEntry){
    const id = Number(btnEntry.getAttribute('data-id'));
    if (!confirm('¿Eliminar esta entrada?')) return;
    await deleteEntry(id);
    renderEntries();
  }
  const btnAlbum = e.target.closest('#albumGrid .del');
  if (btnAlbum){
    const id = Number(btnAlbum.getAttribute('data-id'));
    if (!confirm('Eliminar foto del álbum?')) return;
    await deleteAlbumItem(id);
    renderAlbum();
  }
});

document.getElementById('albumFiles').addEventListener('change', function(ev){
  const files = Array.from(ev.target.files || []);
  if (!files.length) return;
  let remaining = files.length;
  files.forEach((f, idx)=>{
    const reader = new FileReader();
    reader.onload = async function(e){
      const item = { id: Date.now()+idx, src: e.target.result, fecha: new Date().toISOString() };
      await saveAlbumItem(item);
      remaining--;
      if (remaining === 0){
        renderAlbum();
        document.getElementById('albumFiles').value='';
      }
    };
    reader.readAsDataURL(f);
  });
});

/* ---------- Util ---------- */
function escapeHtml(s){ if (!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ---------- Inicialización ---------- */
document.addEventListener('DOMContentLoaded', async function(){
  startTimer();
  await fetchData();
  renderEntries();
  renderAlbum();
});
</script>

