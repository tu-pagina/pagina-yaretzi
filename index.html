
<script type="module">
  // ---------- Firebase ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLDexmuJnSyXeMVOunc7dYdOc1QNeqoWM",
    authDomain: "diario-de-johan-y-yaretzi.firebaseapp.com",
    databaseURL: "https://diario-de-johan-y-yaretzi-default-rtdb.firebaseio.com",
    projectId: "diario-de-johan-y-yaretzi",
    storageBucket: "diario-de-johan-y-yaretzi.firebasestorage.app",
    messagingSenderId: "1058412042433",
    appId: "1:1058412042433:web:18dfa5c64a2ae26389dc40"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- LocalStorage keys ----------
  const STORAGE_ENTRIES = "diario_entries_v1_jy";
  const STORAGE_ALBUM = "album_photos_v1_jy";

  // ---------- Firebase references ----------
  const entriesRef = ref(db, 'entries');
  const albumRef = ref(db, 'album');

  // ---------- Utilities ----------
  function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
  function saveLocalEntries(arr){ localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(arr)); }
  function loadLocalEntries(){ try { return JSON.parse(localStorage.getItem(STORAGE_ENTRIES)) || []; } catch(e){ return []; } }
  function saveLocalAlbum(arr){ localStorage.setItem(STORAGE_ALBUM, JSON.stringify(arr)); }
  function loadLocalAlbum(){ try { return JSON.parse(localStorage.getItem(STORAGE_ALBUM)) || []; } catch(e){ return []; } }

  // ---------- Render ----------
  function renderEntries(entries){
    const container = document.getElementById('entries');
    container.innerHTML = '';
    if (!entries || !entries.length){
      container.innerHTML = '<p class="muted-txt">Aún no hay entradas — añade una desde el formulario.</p>';
      return;
    }
    entries.slice().reverse().forEach(entry => {
      const div = document.createElement('div');
      div.className = 'entry';
      const date = new Date(entry.fecha);
      const dateStr = date.toLocaleString('es-CO', { dateStyle:'medium', timeStyle:'short' });
      div.innerHTML = `
        <div class="meta">
          <div><strong>${escapeHtml(entry.titulo)}</strong><div class="muted-txt">${dateStr}</div></div>
          <div>
            <button class="btn small" data-id="${entry.id}" data-action="del">Eliminar</button>
          </div>
        </div>
        <div style="margin-top:8px">${escapeHtml(entry.texto)}</div>
      `;
      if (entry.foto){
        const img = document.createElement('img');
        img.src = entry.foto;
        img.alt = entry.titulo || 'foto';
        img.style.cursor='zoom-in';
        img.addEventListener('click', ()=> openLightbox(entry.foto));
        div.appendChild(img);
      }
      container.appendChild(div);
    });
  }

  function renderAlbum(album){
    const grid = document.getElementById('albumGrid');
    grid.innerHTML = '';
    if (!album || !album.length){
      grid.innerHTML = '<div class="muted-txt">No hay fotos en el álbum. Sube algunas usando "Seleccionar archivos".</div>';
      return;
    }
    album.slice().reverse().forEach(item=>{
      const node = document.createElement('div');
      node.className = 'album-item';
      node.innerHTML = `<button class="del" title="Eliminar foto" data-id="${item.id}">✕</button>`;
      const img = document.createElement('img');
      img.src = item.src;
      img.alt = 'foto álbum';
      img.addEventListener('click', ()=> openLightbox(item.src));
      node.appendChild(img);
      grid.appendChild(node);
    });
  }

  // ---------- Load from Firebase in realtime ----------
  onValue(entriesRef, snapshot=>{
    const data = snapshot.val();
    const arr = data ? Object.values(data) : [];
    saveLocalEntries(arr);
    renderEntries(arr);
  });

  onValue(albumRef, snapshot=>{
    const data = snapshot.val();
    const arr = data ? Object.values(data) : [];
    saveLocalAlbum(arr);
    renderAlbum(arr);
  });

  // ---------- Add new diary entry ----------
  document.getElementById('diarioForm').addEventListener('submit', function(ev){
    ev.preventDefault();
    const titulo = document.getElementById('titulo').value.trim();
    const texto = document.getElementById('texto').value.trim();
    const fileInput = document.getElementById('foto');
    const file = fileInput.files && fileInput.files[0];
    const id = Date.now();

    const entry = { id, titulo, texto, fecha:new Date().toISOString(), foto:null };

    if (file){
      const reader = new FileReader();
      reader.onload = function(evt){
        entry.foto = evt.target.result;
        push(entriesRef, entry);
        document.getElementById('diarioForm').reset();
      };
      reader.readAsDataURL(file);
    } else {
      push(entriesRef, entry);
      document.getElementById('diarioForm').reset();
    }
  });

  // ---------- Delete entry ----------
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button[data-action="del"]');
    if (!btn) return;
    const id = Number(btn.getAttribute('data-id'));
    if (!confirm('¿Eliminar esta entrada/foto?')) return;

    // Buscar y eliminar en Firebase
    const dbRef = ref(db, 'entries');
    onValue(dbRef, snapshot=>{
      snapshot.forEach(child=>{
        if (child.val().id === id) remove(ref(db, 'entries/' + child.key));
      });
    });

    const albumDBRef = ref(db, 'album');
    onValue(albumDBRef, snapshot=>{
      snapshot.forEach(child=>{
        if (child.val().id === id) remove(ref(db, 'album/' + child.key));
      });
    });
  });

  // ---------- Album upload ----------
  document.getElementById('albumFiles').addEventListener('change', function(ev){
    const files = Array.from(ev.target.files || []);
    if (!files.length) return;

    files.forEach((f, idx)=>{
      const reader = new FileReader();
      reader.onload = function(e){
        const item = { id: Date.now()+idx, src: e.target.result, fecha: new Date().toISOString() };
        push(albumRef, item);
      };
      reader.readAsDataURL(f);
    });
    ev.target.value=''; // limpiar input
  });

  document.getElementById('clearAlbum').addEventListener('click', function(){
    if (!confirm('¿Borrar todo el álbum?')) return;
    onValue(albumRef, snapshot=>{
      snapshot.forEach(child => remove(ref(db, 'album/' + child.key)));
    });
  });

  // ---------- Lightbox ----------
  function openLightbox(src){
    document.getElementById('lightboxImg').src=src;
    const lb=document.getElementById('lightbox');
    lb.style.display='flex';
    lb.setAttribute('aria-hidden','false');
  }
  document.getElementById('lightbox').addEventListener('click', function(){ this.style.display='none'; this.setAttribute('aria-hidden','true'); });

  // ---------- Temporizador ----------
  const targetDate = new Date(2025, 9, 18, 0, 0, 0);
  let timerInterval = null;
  let confettiShown = false;

  function startTimer() {
    document.getElementById('targetDateText').textContent =
      targetDate.toLocaleString('es-CO',{dateStyle:'long',timeStyle:'short'});
    function update(){
      const now = new Date();
      let diff = targetDate.getTime() - now.getTime();
      if (diff <= 0){
        document.getElementById('d').textContent=0;
        document.getElementById('h').textContent=0;
        document.getElementById('m').textContent=0;
        document.getElementById('s').textContent=0;
        if(!confettiShown){ showCelebration(); confettiShown=true; }
        clearInterval(timerInterval);
        return;
      }
      const dias=Math.floor(diff/(1000*60*60*24));
      diff -= dias*(1000*60*60*24);
      const horas=Math.floor(diff/(1000*60*60));
      diff -= horas*(1000*60*60);
      const minutos=Math.floor(diff/(1000*60));
      diff -= minutos*(1000*60);
      const segundos=Math.floor(diff/1000);
      document.getElementById('d').textContent=dias;
      document.getElementById('h').textContent=horas;
      document.getElementById('m').textContent=minutos;
      document.getElementById('s').textContent=segundos;
    }
    update();
    timerInterval=setInterval(update,1000);
  }

  function showCelebration(){
    const container = document.getElementById('hearts'); container.innerHTML='';
    const count=30;
    for(let i=0;i<count;i++){
      const span=document.createElement('span');
      span.className='heart';
      span.textContent=['💖','💘','❤'][Math.floor(Math.random()*3)];
      span.style.left=Math.random()*100+'vw';
      span.style.animationDuration=(4+Math.random()*3)+'s';
      span.style.animationDelay=Math.random()+'s';
      span.style.fontSize=(14+Math.random()*26)+'px';
      container.appendChild(span);
    }
    setTimeout(()=>{ container.innerHTML=''; },9000);
    const countbox=document.getElementById('countbox');
    if(!countbox.querySelector('.cele')){
      const el=document.createElement('div');
      el.className='cele';
      el.style.marginTop='12px';
      el.style.fontWeight='800';
      el.style.fontSize='1.1rem';
      el.style.color='var(--accent)';
      el.textContent='🎉 ¡Hoy es el gran día! 🎉';
      countbox.appendChild(el);
    }
  }

  // ---------- Inicialización ----------
  document.addEventListener('DOMContentLoaded', function(){
    startTimer();
  });

</script>
